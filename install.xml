<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<name>Post and PM Inline Attachments</name>
	<id>Dougiefresh:ILA</id>
	<version>1.4</version>

<!-------------------------------------------------------------------------->
<!-- Source file edits                                                    -->
<!-------------------------------------------------------------------------->
<file name="$sourcedir/Subs.php">
	<operation>
		<search position="after"><![CDATA[// Shall we take the time to cache this?
]]></search>
		<add><![CDATA[// Setup for Inline Attachments
	$message = ILA_Setup($cache_id, $message);
		
	]]></add>
	</operation>
</file>
<file name="$sourcedir/Display.php">
	<operation>
		<search position="replace"><![CDATA[loadAttachmentContext($message['id_msg']),]]></search>
		<add><![CDATA[$context['ila_attachments'],]]></add>
	</operation>
</file>
<file name="$sourcedir/Post.php">
	<operation>
		<search position="replace"><![CDATA[loadLanguage('Post');

	// You can't reply with a poll... hacker.]]></search>
		<add><![CDATA[loadLanguage('Post+Modifications');

	// You can't reply with a poll... hacker.]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[
		$row['body'] = parse_bbc($row['body'], $row['smileys_enabled'], $row['id_msg']);
]]></search>
		<add><![CDATA[
		// Show attachment string or error message in topic history
		$row['body'] = ILA_Remove_Tags($row['body']);
]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[
			$context['preview_message'] = parse_bbc($context['preview_message'], isset($_REQUEST['ns']) ? 0 : 1);
]]></search>
		<add><![CDATA[
			// Show attachment string or error message in topic history
			$context['preview_message'] = ILA_Remove_Tags($context['preview_message']);
]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[removeAttachments($attachmentQuery);
]]></search>
		<add><![CDATA[$_POST['message'] = ILA_Remove_Attachment($_POST['message'], $attachmentQuery);
		]]></add>
	</operation>
</file>
<file name="$sourcedir/Recent.php">
	<operation>
		<search position="before"><![CDATA[
		$row['body'] = parse_bbc($row['body'], $row['smileys_enabled'], $row['id_msg']);
]]></search>
		<add><![CDATA[

		// Show attachment string or error message in topic history
		$row['body'] = ILA_Remove_Tags($row['body']);

]]></add>
	</operation>
</file>
<file name="$sourcedir/PersonalMessage.php">
	<operation>
		<search position="replace"><![CDATA[loadLanguage('PersonalMessage');

	if (WIRELESS && WIRELESS_PROTOCOL == 'wap')]]></search>
		<add><![CDATA[loadLanguage('PersonalMessage+Modifications');

	if (WIRELESS && WIRELESS_PROTOCOL == 'wap')]]></add>
	</operation>
	<operation error="ignore">
		<search position="replace"><![CDATA[loadPMAttachmentContext($message['id_pm']),]]></search>
		<add><![CDATA[$context['ila_attachments'],]]></add>
	</operation>
</file>

<!-------------------------------------------------------------------------->
<!-- Curve theme Post Display Template file edits                         -->
<!-------------------------------------------------------------------------->
<file name="$themedir/Display.template.php">
	<operation>
		<search position="replace"><![CDATA[if ($attachment['is_image'])]]></search>
		<add><![CDATA[if ($attachment['is_image'] && !isset($context['dontshowattachment'][$attachment['id']]))]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[echo '
										<a href="' . $attachment['href'] . '"><img src="' . $settings['images_url'] . '/icons/clip.gif" align="middle" alt="*" />&nbsp;' . $attachment['name'] . '</a> ';]]></search>
        <add><![CDATA[if (!isset($context['dontshowattachment'][$attachment['id']]))
				echo '
										<a href="' . $attachment['href'] . '"><img src="' . $settings['images_url'] . '/icons/clip.gif" align="middle" alt="*" border="0" />&nbsp;' . $attachment['name'] . '</a> ';]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[echo '
										(', $attachment['size'], ($attachment['is_image'] ? ', ' . $attachment['real_width'] . 'x' . $attachment['real_height'] . ' - ' . $txt['attach_viewed'] : ' - ' . $txt['attach_downloaded']) . ' ' . $attachment['downloads'] . ' ' . $txt['attach_times'] . '.)<br />';]]></search>
	<add><![CDATA[if (!isset($context['dontshowattachment'][$attachment['id']]))
				]]></add>
	</operation>
</file>

<!-------------------------------------------------------------------------->
<!-- Curve theme Personal Message Template file edits                     -->
<!-------------------------------------------------------------------------->
<file name="$themedir/PersonalMessage.template.php">
	<!-- PM Display code -->
	<operation error="ignore">
		<search position="before"><![CDATA[if ($attachment['is_image']]]></search>
		<add><![CDATA[ && !isset($context['dontshowattachment'][$attachment['id']])]]></add>
	</operation>
	<operation error="ignore">
		<search position="after"><![CDATA[echo '
								<a href="' . $attachment['href'] . '"><img src="' . $settings['images_url'] . '/icons/clip.gif" align="middle" alt="*" border="0" />&nbsp;' . $attachment['name'] . '</a> ';]]></search>
		<add><![CDATA[if (!isset($context['dontshowattachment'][$attachment['id']]))
				]]></add>
	</operation>
	<operation error="ignore">
		<search position="after"><![CDATA[echo '
										(', $attachment['size'], ($attachment['is_image'] ? ', ' . $attachment['real_width'] . 'x' . $attachment['real_height'] . ' - ' . $txt['attach_viewed'] : ' - ' . $txt['attach_downloaded']) . ' ' . $attachment['downloads'] . ' ' . $txt['attach_times'] . '.)<br />';]]></search>
		<add><![CDATA[if (!isset($context['dontshowattachment'][$attachment['id']]))
						]]></add>
	</operation>

	<!-- PM Posting code -->
	<operation error="ignore">
		<search position="replace"><![CDATA[
			foreach ($context['current_attachments'] as $attachment)
				echo '
					<dd class="smalltext">
						<label for="attachment_', $attachment['id'], '"><input type="checkbox" id= "attachment_', $attachment['id'], '" name="attach_del[]" value="', $attachment['id'], '"', empty($attachment['unchecked']) ? ' checked="checked"' : '', ' class="input_check" /> ', $attachment['name'], '</label>
]]></search>
		<add><![CDATA[
			foreach ($context['current_attachments'] as $attid => $attachment)
				echo '
					<dd class="smalltext">
						<label for="attachment_', $attachment['id'], '"><input type="checkbox" id="attachment_', $attachment['id'], '" name="attach_del[]" value="', $attachment['id'], '"', empty($attachment['unchecked']) ? ' checked="checked"' : '', ' class="input_check" /> ', $attachment['name'], '	<a href="javascript:void(0);" onclick="replaceText(\'[attachment=',$attid,'][/attachment]\', document.forms.postmodify.', $context['post_box_name'], '); return false;">(', $txt['ila_insert'] ,' ', $attid,')</a></label>
]]></add>
	</operation>
	<operation error="ignore">
		<search position="replace"><![CDATA[
									<input type="file" size="38" name="attachment[]" class="input_file" />';]]></search>
		<add><![CDATA[
									<input type="file" size="60" name="attachment[]" id="attachment1" class="input_file" /> (<a href="javascript:void(0);" onclick="replaceText(\'[attachment=', (empty($context['current_attachments']) ? 0 : count($context['current_attachments'])) ,'][/attachment]\', document.forms.postmodify.', $context['post_box_name'], '); return false;">', $txt['ila_insert'] ,' ', (empty($context['current_attachments']) ? 0 : count($context['current_attachments'])) ,'</a>)';]]></add>
	</operation>
	<operation error="ignore">
		<search position="replace"><![CDATA[
										function addAttachment()
										{
											if (allowed_attachments <= 0)
												return alert("', $txt['more_attachments_error'], '");

											setOuterHTML(document.getElementById("moreAttachments"), \'<dd class="smalltext"><input type="file" size="38" name="attachment[]" class="input_file" /><\' + \'/dd><dd class="smalltext" id="moreAttachments"><a href="javascript:void(0);" onclick="addAttachment(); return false;">(', $txt['more_attachments'], ')<\' + \'/a><\' + \'/dd>\');

											allowed_attachments = allowed_attachments - 1;

											return true;
										}
]]></search>
		<add><![CDATA[										var current_attachment = 1;

										function addAttachment()
										{
											current_attachment = current_attachment + 1;
											if (allowed_attachments <= 0)
												return alert("', $txt['more_attachments_error'], '");

											setOuterHTML(document.getElementById("moreAttachments"), \'<dd class="smalltext"><input type="file" size="60" name="attachment[]" id="attachment\' + (current_attachment - 1) + \'" class="input_file" /> (<a href="javascript:void(0);" onclick="replaceText(\\\'[attachment=\' + (current_attachment - 1) + \'][/attachment]\\\', document.forms.postmodify.', $context['post_box_name'], '); return false;">', $txt['ila_insert'] ,' \' + (current_attachment - 1) + \')</a>\' + \'</dd><dd class="smalltext" id="moreAttachments"><a href="#" onclick="addAttachment(); return false;">(', $txt['more_attachments'], ')<\' + \'/a><\' + \'/dd>\');

											allowed_attachments = allowed_attachments - 1;

											return true;
										}
]]></add>
	</operation>
</file>

<!-------------------------------------------------------------------------->
<!-- Post Editing Template file edits                                     -->
<!-------------------------------------------------------------------------->
<file name="$themedir/Post.template.php">
	<operation>
		<search position="replace"><![CDATA[
		foreach ($context['current_attachments'] as $attachment)
			echo '
						<dd class="smalltext">
							<label for="attachment_', $attachment['id'], '"><input type="checkbox" id="attachment_', $attachment['id'], '" name="attach_del[]" value="', $attachment['id'], '"', empty($attachment['unchecked']) ? ' checked="checked"' : '', ' class="input_check" /> ', $attachment['name'], (empty($attachment['approved']) ? ' (' . $txt['awaiting_approval'] . ')' : ''), '</label>
]]></search>
		<add><![CDATA[
		foreach ($context['current_attachments'] as $attid => $attachment)
			echo '
						<dd class="smalltext">
							<label for="attachment_', $attachment['id'], '"><input type="checkbox" id="attachment_', $attachment['id'], '" name="attach_del[]" value="', $attachment['id'], '"', empty($attachment['unchecked']) ? ' checked="checked"' : '', ' class="input_check" /> ', $attachment['name'], (empty($attachment['approved']) ? ' (' . $txt['awaiting_approval'] . ')' : ''), '	<a href="javascript:void(0);" onclick="replaceText(\'[attachment=',$attid,'][/attachment]\', document.forms.postmodify.', $context['post_box_name'], '); return false;">(', $txt['ila_insert'] ,' ', $attid,')</a></label>
]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[
							<input type="file" size="60" name="attachment[]" id="attachment1" class="input_file" />]]></search>
		<add><![CDATA[
							<input type="file" size="60" name="attachment[]" id="attachment1" class="input_file" /> (<a href="javascript:void(0);" onclick="replaceText(\'[attachment=', (empty($context['current_attachments']) ? 0 : count($context['current_attachments'])) ,'][/attachment]\', document.forms.postmodify.', $context['post_box_name'], '); return false;">', $txt['ila_insert'] ,' ', (empty($context['current_attachments']) ? 0 : count($context['current_attachments'])) ,'</a>)]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[
								function addAttachment()
								{
									allowed_attachments = allowed_attachments - 1;
									current_attachment = current_attachment + 1;
									if (allowed_attachments <= 0)
										return alert("', $txt['more_attachments_error'], '");

									setOuterHTML(document.getElementById("moreAttachments"), \'<dd class="smalltext"><input type="file" size="60" name="attachment[]" id="attachment\' + current_attachment + \'" class="input_file" /> (<a href="javascript:void(0);" onclick="cleanFileInput(\\\'attachment\' + current_attachment + \'\\\');">', $txt['clean_attach'], '</a>)\' + \'</dd><dd class="smalltext" id="moreAttachments"><a href="#" onclick="addAttachment(); return false;">(', $txt['more_attachments'], ')<\' + \'/a><\' + \'/dd>\');

									return true;
								}
]]></search>
		<add><![CDATA[
								function addAttachment()
								{
									allowed_attachments = allowed_attachments - 1;
									current_attachment = current_attachment + 1;
									if (allowed_attachments <= 0)
										return alert("', $txt['more_attachments_error'], '");

									setOuterHTML(document.getElementById("moreAttachments"), \'<dd class="smalltext"><input type="file" size="60" name="attachment[]" id="attachment\' + (current_attachment - 1) + \'" class="input_file" /> (<a href="javascript:void(0);" onclick="replaceText(\\\'[attachment=\' + (current_attachment - 1) + \'][/attachment]\\\', document.forms.postmodify.', $context['post_box_name'], '); return false;">', $txt['ila_insert'] ,' \' + (current_attachment - 1) + \')</a> (<a href="javascript:void(0);" onclick="cleanFileInput(\\\'attachment\' + (current_attachment - 1) + \'\\\');">', $txt['clean_attach'], '</a>)\' + \'</dd><dd class="smalltext" id="moreAttachments"><a href="#" onclick="addAttachment(); return false;">(', $txt['more_attachments'], ')<\' + \'/a><\' + \'/dd>\');

									return true;
								}
]]></add>
	</operation>
</file>

<!-------------------------------------------------------------------------->
<!-- Core theme Post Display Template file edits                          -->
<!-------------------------------------------------------------------------->
<file name="$boarddir/Themes/core/Display.template.php" error="skip">
	<operation>
		<search position="replace"><![CDATA[if ($attachment['is_image'])]]></search>
		<add><![CDATA[if ($attachment['is_image'] && !isset($context['dontshowattachment'][$attachment['id']]))]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[echo '
								<a href="' . $attachment['href'] . '"><img src="' . $settings['images_url'] . '/icons/clip.gif" align="middle" alt="*" border="0" />&nbsp;' . $attachment['name'] . '</a> ';]]></search>
		<add><![CDATA[if (!isset($context['dontshowattachment'][$attachment['id']]))
				echo '
								<a href="' . $attachment['href'] . '"><img src="' . $settings['images_url'] . '/icons/clip.gif" align="middle" alt="*" border="0" />&nbsp;' . $attachment['name'] . '</a> ';]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[echo '
										(', $attachment['size'], ($attachment['is_image'] ? ', ' . $attachment['real_width'] . 'x' . $attachment['real_height'] . ' - ' . $txt['attach_viewed'] : ' - ' . $txt['attach_downloaded']) . ' ' . $attachment['downloads'] . ' ' . $txt['attach_times'] . '.)<br />';
]]></search>
		<add><![CDATA[if (!isset($context['dontshowattachment'][$attachment['id']]))
					echo '
										(', $attachment['size'], ($attachment['is_image'] ? ', ' . $attachment['real_width'] . 'x' . $attachment['real_height'] . ' - ' . $txt['attach_viewed'] : ' - ' . $txt['attach_downloaded']) . ' ' . $attachment['downloads'] . ' ' . $txt['attach_times'] . '.)<br />';]]></add>
	</operation>
</file>

<!-------------------------------------------------------------------------->
<!-- Highslide4SMF v0.8.1 support file edit                               -->
<!-------------------------------------------------------------------------->
<file name="$sourcedir/hs4smf-Subs.php" error="skip">
	<operation>
		<search position="replace"><![CDATA[			elseif (stripos($image['img_tag'], 'index.php?action=dlattach;'))
				continue;]]></search>
		<add><![CDATA[// Inline Attachments (ILA) commented these out...
//			elseif (stripos($image['img_tag'], 'index.php?action=dlattach;'))
//				continue;]]></add>
	</operation>
</file>
</modification>